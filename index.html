<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur de Rentabilit√© pour Investissement</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0284c7"/>
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/0284c7/white?text=P">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
    body {
        font-family: 'Inter', sans-serif;
    }
    .info-icon {
        cursor: help;
    }
    .info-tooltip {
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.3s;
    }
    .info-icon:hover .info-tooltip {
        visibility: visible;
        opacity: 1;
    }
    .result-card {
        transition: all 0.3s ease-in-out;
    }
    .simulation-item:hover, .project-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .sort-btn.active {
        background-color: #3b82f6; /* bg-blue-600 */
        color: white;
    }
    .highlight-year td, .highlight-year th {
        background-color: #e0f2fe; /* sky-100 */
    }

    @media (max-width: 767px) {
        .info-tooltip {
            left: auto !important;
            right: 0 !important;
            transform: translateX(0) !important;
        }
    }

    @media print {
        body {
            -webkit-print-color-adjust: exact !important;
            color-adjust: exact !important;
        }
        .no-print, #auth-container, #logout-btn-container, #back-to-selector-container {
            display: none !important;
        }
        #app-container, body, .container {
            display: block !important;
            padding: 0;
            margin: 0;
            width: 100%;
            max-width: 100% !important;
        }
        main, #results-section > div, .bg-white {
             background-color: #ffffff !important;
             color: #000000 !important;
             box-shadow: none !important;
             border: 1px solid #e2e8f0; /* slate-200 */
             page-break-inside: avoid;
        }
        .text-slate-900, .text-slate-800, .text-slate-700, .text-slate-600, .text-slate-500,
        .text-green-900, .text-green-800, .text-red-900, .text-red-800,
        .text-blue-900, .text-blue-800, .text-blue-700 {
            color: #000000 !important;
        }
         .bg-slate-100, .bg-green-50, .bg-red-50, .bg-blue-50, .bg-slate-50 {
            background-color: #f1f5f9 !important; /* light gray for contrast */
        }
        .printable-table-container {
            max-height: none !important;
            overflow: visible !important;
        }
    }
</style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="auth-container" class="min-h-screen flex items-center justify-center">
        <div class="w-full max-w-md mx-auto p-4">
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold text-center text-slate-900 mb-6">Acc√®s Investisseur</h2>
                <div id="auth-error" class="text-red-500 text-sm text-center mb-4 hidden"></div>
          
                <form id="login-form" class="space-y-4">
                    <input type="email" id="email" placeholder="Adresse e-mail" required class="w-full bg-slate-100 border-transparent rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500">
                    <input type="password" id="password" placeholder="Mot de passe" required class="w-full bg-slate-100 border-transparent rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500">
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md">Se connecter</button>
                    <p class="text-center text-sm text-slate-600 pt-2">Pas de compte ? <a href="#" id="show-signup" class="font-semibold text-blue-600 hover:underline">Inscrivez-vous</a></p>
                </form>
                <form id="signup-form" class="space-y-4 hidden">
                     <input type="email" id="signup-email" placeholder="Adresse e-mail" required class="w-full bg-slate-100 border-transparent rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500">
                    <input type="password" id="signup-password" placeholder="Mot de passe (6 car. min)" required class="w-full bg-slate-100 border-transparent rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500">
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 shadow-md">Cr√©er un compte</button>
                     <p class="text-center text-sm text-slate-600 pt-2">D√©j√† un compte ? <a href="#" id="show-login" class="font-semibold text-blue-600 hover:underline">Connectez-vous</a></p>
                </form>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-5xl">
            <div id="logout-btn-container" class="text-right mb-4 no-print">
                 <button id="logout-btn" class="bg-slate-700 hover:bg-slate-800 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md">D√©connexion</button>
            </div>
            
            <div id="project-selector">
                <header class="text-center mb-12">
                    <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">Bienvenue, Investisseur !</h1>
                    <p class="text-slate-600 mt-2">Quel type de projet souhaitez-vous simuler aujourd'hui ?</p>
                </header>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                    <div id="select-parking" class="project-card bg-white p-8 rounded-2xl shadow-lg cursor-pointer transition duration-300">
                        <span class="text-5xl">üöó</span>
                        <h2 class="text-2xl font-bold text-slate-800 mt-4">Parking / Garage</h2>
                        <p class="text-slate-500 mt-2">Simulez la rentabilit√© d'un ou plusieurs lots de parkings.</p>
                    </div>
                    <div id="select-logement" class="project-card bg-white p-8 rounded-2xl shadow-lg cursor-pointer transition duration-300">
                        <span class="text-5xl">üè†</span>
                        <h2 class="text-2xl font-bold text-slate-800 mt-4">Logement</h2>
                        <p class="text-slate-500 mt-2">Analysez un investissement locatif r√©sidentiel.</p>
                    </div>
                    <div id="select-cave" class="project-card bg-white p-8 rounded-2xl shadow-lg cursor-pointer transition duration-300">
                        <span class="text-5xl">üì¶</span>
                        <h2 class="text-2xl font-bold text-slate-800 mt-4">Cave / Box</h2>
                        <p class="text-slate-500 mt-2">Estimez le potentiel de la location d'espaces de stockage.</p>
                    </div>
                </div>
            </div>

            <main id="simulator-container" class="hidden grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-1 self-start">
                    <div id="back-to-selector-container" class="text-left mb-6 no-print">
                        <button id="back-to-selector" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-3 rounded-lg transition duration-300 shadow-md inline-flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                            Changer de projet
                        </button>
                    </div>
                    <div id="form-container" class="bg-white p-6 rounded-2xl shadow-lg self-start no-print">
                        <template id="tooltip-template">
                            <div class="relative info-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-sky-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                <div class="info-tooltip absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 p-3 bg-slate-800 text-white text-xs text-center rounded-lg shadow-lg pointer-events-none z-10"></div>
                            </div>
                        </template>

                        <div id="form-parking-wrapper" class="hidden">
                            <h2 class="text-xl font-bold mb-6 border-b pb-3">Investissement Parking üöó</h2>
                            <form id="investment-form-parking" class="space-y-4">
                                <div>
                                    <div class="flex items-center justify-between">
                                        <label for="parking-city-name" class="block text-sm font-medium text-slate-700">Nom de la Ville</label>
                                        <div data-tooltip="Nom de la ville o√π se situe le bien, utilis√© pour le titre de la simulation."></div>
                                    </div>
                                    <input type="text" id="parking-city-name" value="Paris" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between">
                                        <label for="parking-announcement-link" class="block text-sm font-medium text-slate-700">Lien de l'annonce</label>
                                        <div data-tooltip="Optionnel : collez ici le lien de l'annonce pour le retrouver facilement."></div>
                                    </div>
                                    <input type="url" id="parking-announcement-link" placeholder="https://..." class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <h3 class="text-lg font-semibold pt-4 mt-4 border-t">D√©tails du bien</h3>
                                <div>
                                    <div class="flex items-center justify-between">
                                        <label for="parking-purchase-price" class="block text-sm font-medium text-slate-700">Prix affich√© du lot (‚Ç¨)</label>
                                        <div data-tooltip="Prix de vente affich√© dans l'annonce, avant toute n√©gociation."></div>
                                    </div>
                                    <input type="text" id="parking-purchase-price" value="100000" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between">
                                        <label for="parking-negotiation-rate" class="block text-sm font-medium text-slate-700">N√©gociation sur le prix (%)</label>
                                        <div data-tooltip="Pourcentage de r√©duction que vous pensez pouvoir n√©gocier sur le prix affich√©."></div>
                                    </div>
                                    <input type="number" id="parking-negotiation-rate" value="5" step="0.1" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between">
                                        <label for="parking-spaces-count" class="block text-sm font-medium text-slate-700">Nombre de places</label>
                                        <div data-tooltip="Nombre total de places de parking dans le lot que vous achetez."></div>
                                    </div>
                                    <input type="number" id="parking-spaces-count" value="10" min="1" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between">
                                        <label for="parking-rent-per-space" class="block text-sm font-medium text-slate-700">Loyer mensuel / place (‚Ç¨)</label>
                                        <div data-tooltip="Indiquez le loyer mensuel par place, charges comprises (CC)."></div>
                                    </div>
                                    <input type="number" id="parking-rent-per-space" value="70" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <h3 class="text-lg font-semibold pt-4 mt-4 border-t">Fiscalit√©</h3>
                                <div>
                                    <div class="flex items-center justify-between">
                                        <label for="parking-tax-regime" class="block text-sm font-medium text-slate-700">R√©gime d'imposition</label>
                                        <div data-tooltip="Micro-BIC : Abattement de 50% sur les revenus. R√©gime R√©el : D√©duction des charges r√©elles (int√©r√™ts, taxes, etc.)."></div>
                                    </div>
                                    <select id="parking-tax-regime" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="none">Pas d'imposition (simulation)</option>
                                        <option value="micro" selected>R√©gime Micro-BIC</option>
                                        <option value="reel">R√©gime R√©el</option>
                                    </select>
                                </div>
                                <div>
                                    <div class="flex items-center justify-between">
                                        <label for="parking-tmi" class="block text-sm font-medium text-slate-700">Tranche Marginale d'Imposition (%)</label>
                                        <div data-tooltip="Votre taux d'imposition le plus √©lev√© (0, 11, 30, 41 ou 45%). Les revenus locatifs sont ajout√©s √† vos autres revenus et impos√©s √† ce taux."></div>
                                    </div>
                                    <select id="parking-tmi" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="0">0 %</option>
                                        <option value="11">11 %</option>
                                        <option value="30" selected>30 %</option>
                                        <option value="41">41 %</option>
                                        <option value="45">45 %</option>
                                    </select>
                                </div>
                                <h3 class="text-lg font-semibold pt-4 mt-4 border-t">Param√®tres d'√âvolution</h3>
                                <div>
                                    <div class="flex items-center justify-between">
                                        <label for="parking-appreciation-rate" class="block text-sm font-medium text-slate-700">Revalorisation annuelle du lot (%)</label>
                                        <div data-tooltip="Estimation de l'augmentation annuelle de la valeur du bien. Une moyenne se situe entre 1% et 2%."></div>
                                    </div>
                                    <input type="number" id="parking-appreciation-rate" value="1" step="0.1" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between">
                                        <label for="parking-rent-increase-rate" class="block text-sm font-medium text-slate-700">Revalorisation annuelle loyers (%)</label>
                                        <div data-tooltip="Augmentation annuelle des loyers, souvent bas√©e sur l'indice IRL (environ 2% en moyenne)."></div>
                                    </div>
                                    <input type="number" id="parking-rent-increase-rate" value="2" step="0.1" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between">
                                        <label for="parking-charges-increase-rate" class="block text-sm font-medium text-slate-700">Revalorisation annuelle charges (%)</label>
                                        <div data-tooltip="Augmentation annuelle des charges (copropri√©t√©, PNO, taxe fonci√®re)."></div>
                                    </div>
                                    <input type="number" id="parking-charges-increase-rate" value="1.5" step="0.1" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <h3 class="text-lg font-semibold pt-4 mt-4 border-t">Param√®tres du Financement</h3>
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between">
                                        <label for="parking-notary-fees" class="block text-sm font-medium text-slate-700">Frais de notaire (‚Ç¨)</label>
                                        <div data-tooltip="Calcul√©s automatiquement √† 12% du prix n√©goci√© (taux courant pour les parkings), ou saisissables manuellement."></div>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span></span>
                                        <div class="flex items-center">
                                            <span class="text-xs text-slate-500 mr-2">Manuelle</span>
                                            <label for="parking-toggle-notary-fees" class="inline-flex relative items-center cursor-pointer">
                                                <input type="checkbox" value="" id="parking-toggle-notary-fees" class="sr-only peer">
                                                <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                            </label>
                                        </div>
                                    </div>
                                    <input type="text" id="parking-notary-fees" placeholder="Calcul√© √† 12%" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 transition" disabled>
                                </div>
                                <div>
                                    <div class="flex items-center justify-between">
                                        <label for="parking-personal-contribution" class="block text-sm font-medium text-slate-700">Apport personnel (‚Ç¨)</label>
                                        <div data-tooltip="Montant que vous financez sans emprunter. L'apport couvre g√©n√©ralement au minimum les frais de notaire."></div>
                                    </div>
                                    <input type="text" id="parking-personal-contribution" value="0" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between">
                                        <label for="parking-loan-rate" class="block text-sm font-medium text-slate-700">Taux du cr√©dit (%)</label>
                                        <div data-tooltip="Taux d'int√©r√™t annuel du pr√™t. Taux excellent mis √† jour automatiquement en fonction de la dur√©e."></div>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span></span>
                                        <div class="flex items-center">
                                            <span id="parking-loan-rate-status" class="text-xs text-slate-500 mr-2">Auto</span>
                                            <label for="parking-toggle-loan-rate" class="inline-flex relative items-center cursor-pointer">
                                                <input type="checkbox" value="" id="parking-toggle-loan-rate" class="sr-only peer">
                                                <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                            </label>
                                        </div>
                                    </div>
                                    <input type="number" id="parking-loan-rate" value="3.25" step="0.01" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500" disabled>
                                </div>
                                <div>
                                    <div class="flex items-center justify-between">
                                        <label for="parking-loan-insurance-rate" class="block text-sm font-medium text-slate-700">Taux d'assurance cr√©dit (%)</label>
                                        <div data-tooltip="Taux annuel de l'assurance emprunteur, calcul√© sur le montant total emprunt√©."></div>
                                    </div>
                                    <input type="number" id="parking-loan-insurance-rate" value="0.35" step="0.01" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between">
                                        <label for="parking-loan-duration" class="block text-sm font-medium text-slate-700">Dur√©e du cr√©dit (ann√©es)</label>
                                        <div data-tooltip="Dur√©e totale de remboursement du pr√™t."></div>
                                    </div>
                                    <select id="parking-loan-duration" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="10">10 ans</option>
                                        <option value="15">15 ans</option>
                                        <option value="20">20 ans</option>
                                        <option value="25" selected>25 ans</option>
                                    </select>
                                </div>
                                <h3 class="text-lg font-semibold pt-4 mt-4 border-t">Charges Annuelles & Mensuelles</h3>
                                <div>
                                    <div class="flex items-center justify-between">
                                        <label for="parking-pno-insurance" class="block text-sm font-medium text-slate-700">Assurance PNO annuelle / place (‚Ç¨)</label>
                                        <div data-tooltip="Assurance Propri√©taire Non Occupant. Obligatoire pour un bien en location."></div>
                                    </div>
                                    <input type="number" id="parking-pno-insurance" value="30" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between">
                                        <label for="parking-co-ownership-charges" class="block text-sm font-medium text-slate-700">Charges copro. mensuelles / place (‚Ç¨)</label>
                                        <div data-tooltip="Charges de copropri√©t√© non r√©cup√©rables sur le locataire (ex: honoraires du syndic, entretien des parties communes)."></div>
                                    </div>
                                    <input type="number" id="parking-co-ownership-charges" value="10" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div class="space-y-2 pt-2">
                                    <div class="flex items-center justify-between">
                                        <label for="parking-property-tax" class="block text-sm font-medium text-slate-700">Taxe fonci√®re annuelle (‚Ç¨)</label>
                                        <div data-tooltip="Calcul√©e par d√©faut sur la base d'un mois de loyer total, ou saisissable manuellement."></div>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span></span>
                                        <div class="flex items-center">
                                            <span class="text-xs text-slate-500 mr-2">Manuelle</span>
                                            <label for="parking-toggle-property-tax" class="inline-flex relative items-center cursor-pointer">
                                                <input type="checkbox" value="" id="parking-toggle-property-tax" class="sr-only peer">
                                                <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                            </label>
                                        </div>
                                    </div>
                                    <input type="text" id="parking-property-tax" placeholder="Calcul√©e sur 1 mois de loyer" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 transition" disabled>
                                </div>
                                <h3 class="text-lg font-semibold pt-4 mt-4 border-t">‚ö°Ô∏è Option : √âlectrification</h3>
                                <div>
                                    <div class="flex items-center justify-between">
                                        <label for="parking-electrification-cost-per-space" class="block text-sm font-medium text-slate-700">Co√ªt des travaux / place (‚Ç¨)</label>
                                        <div data-tooltip="Co√ªt d'installation d'une borne de recharge par place. Peut √™tre financ√© par l'emprunt."></div>
                                    </div>
                                    <input type="text" id="parking-electrification-cost-per-space" placeholder="ex: 1500" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between">
                                        <label for="parking-electrification-spaces-count" class="block text-sm font-medium text-slate-700">Nombre de places √† √©lectrifier</label>
                                    </div>
                                    <select id="parking-electrification-spaces-count" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500"></select>
                                </div>
                                <div>
                                    <div class="flex items-center justify-between">
                                        <label for="parking-electrification-year" class="block text-sm font-medium text-slate-700">Ann√©e de r√©alisation des travaux</label>
                                    </div>
                                    <input type="number" id="parking-electrification-year" value="1" min="1" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between">
                                        <label for="parking-new-rent-per-space" class="block text-sm font-medium text-slate-700">Nouveau loyer / place √©lectrifi√©e (‚Ç¨)</label>
                                        <div data-tooltip="Le nouveau loyer (CC) pour les places qui seront √©quip√©es d'une borne."></div>
                                    </div>
                                    <input type="number" id="parking-new-rent-per-space" placeholder="ex: 100" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div class="form-actions pt-6 border-t"></div>
                            </form>
                        </div>
                        
                        <div id="form-logement-wrapper" class="hidden">
                            <h2 class="text-xl font-bold mb-6 border-b pb-3">Investissement Logement üè†</h2>
                            <form id="investment-form-logement" class="space-y-4">

<div>
    <div class="flex items-center justify-between">
        <label for="logement-investment-horizon" class="block text-sm font-medium text-slate-700">Horizon de revente (ann√©es)</label>
        <div data-tooltip="Choisissez l'ann√©e √† laquelle vous souhaitez simuler la revente pour le bilan final."></div>
    </div>
    <select id="logement-investment-horizon" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
        <option value="10">10 ans</option>
        <option value="15">15 ans</option>
        <option value="20">20 ans</option>
        <option value="25">25 ans</option>
        <option value="30" selected>30 ans</option>
    </select>
</div>

<h3 class="text-lg font-semibold pt-4 mt-4 border-t">Param√®tres du Financement</h3>

                                <div>
                                    <div class="flex items-center justify-between"><label for="logement-city-name" class="block text-sm font-medium text-slate-700">Nom de la Ville</label><div data-tooltip="Nom de la ville o√π se situe le bien."></div></div>
                                    <input type="text" id="logement-city-name" value="Lyon" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="logement-announcement-link" class="block text-sm font-medium text-slate-700">Lien de l'annonce</label><div data-tooltip="Optionnel : collez ici le lien de l'annonce."></div></div>
                                    <input type="url" id="logement-announcement-link" placeholder="https://..." class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <h3 class="text-lg font-semibold pt-4 mt-4 border-t">D√©tails du bien</h3>
                                <div>
                                    <div class="flex items-center justify-between"><label for="logement-purchase-price" class="block text-sm font-medium text-slate-700">Prix affich√© du bien (‚Ç¨)</label></div>
                                    <input type="text" id="logement-purchase-price" value="200000" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="logement-agency-fees" class="block text-sm font-medium text-slate-700">Frais d'agence (%)</label></div>
                                    <input type="number" id="logement-agency-fees" value="4" step="0.1" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="logement-negotiation-rate" class="block text-sm font-medium text-slate-700">N√©gociation sur le prix (%)</label></div>
                                    <input type="number" id="logement-negotiation-rate" value="3" step="0.1" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="logement-works-cost" class="block text-sm font-medium text-slate-700">Co√ªt des travaux (‚Ç¨)</label></div>
                                    <input type="text" id="logement-works-cost" value="10000" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <h3 class="text-lg font-semibold pt-4 mt-4 border-t">Revenus Locatifs</h3>
                                <div>
                                    <div class="flex items-center justify-between"><label for="logement-monthly-rent-hc" class="block text-sm font-medium text-slate-700">Loyer mensuel Hors Charges (‚Ç¨)</label></div>
                                    <input type="number" id="logement-monthly-rent-hc" value="850" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="logement-monthly-charges" class="block text-sm font-medium text-slate-700">Charges locatives mensuelles (‚Ç¨)</label></div>
                                    <input type="number" id="logement-monthly-charges" value="60" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="logement-vacancy-rate" class="block text-sm font-medium text-slate-700">Taux de vacance locative (%)</label><div data-tooltip="Pourcentage des loyers annuels que vous estimez ne pas percevoir (impay√©s, vacances...). 8% ‚âà 1 mois de loyer."></div></div>
                                    <input type="number" id="logement-vacancy-rate" value="8" step="0.5" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <h3 class="text-lg font-semibold pt-4 mt-4 border-t">Fiscalit√©</h3>
                                <div>
                                    <div class="flex items-center justify-between"><label for="logement-tax-regime" class="block text-sm font-medium text-slate-700">R√©gime d'imposition</label></div>
                                    <select id="logement-tax-regime" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                        <option value="none">Pas d'imposition</option>
                                        <option value="micro">Micro-BIC (LMNP)</option>
                                        <option value="reel" selected>R√©gime R√©el (LMNP)</option>
                                    </select>
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="logement-tmi" class="block text-sm font-medium text-slate-700">TMI (%)</label></div>
                                    <select id="logement-tmi" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                        <option value="0">0 %</option><option value="11">11 %</option><option value="30" selected>30 %</option><option value="41">41 %</option><option value="45">45 %</option>
                                    </select>
                                </div>
                                <h3 class="text-lg font-semibold pt-4 mt-4 border-t">Param√®tres d'√âvolution</h3>
                                <div>
                                    <div class="flex items-center justify-between"><label for="logement-appreciation-rate" class="block text-sm font-medium text-slate-700">Revalorisation annuelle du bien (%)</label></div>
                                    <input type="number" id="logement-appreciation-rate" value="1.5" step="0.1" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="logement-rent-increase-rate" class="block text-sm font-medium text-slate-700">Revalorisation annuelle loyers (%)</label></div>
                                    <input type="number" id="logement-rent-increase-rate" value="2" step="0.1" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="logement-charges-increase-rate" class="block text-sm font-medium text-slate-700">Revalorisation annuelle charges (%)</label></div>
                                    <input type="number" id="logement-charges-increase-rate" value="1.5" step="0.1" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <h3 class="text-lg font-semibold pt-4 mt-4 border-t">Param√®tres du Financement</h3>
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between"><label for="logement-notary-fees" class="block text-sm font-medium text-slate-700">Frais de notaire (‚Ç¨)</label><div data-tooltip="Calcul√©s automatiquement √† 8% du prix n√©goci√©."></div></div>
                                    <div class="flex items-center justify-between"><span></span><div class="flex items-center"><span class="text-xs text-slate-500 mr-2">Manuelle</span><label for="logement-toggle-notary-fees" class="inline-flex relative items-center cursor-pointer"><input type="checkbox" id="logement-toggle-notary-fees" class="sr-only peer"><div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label></div></div>
                                    <input type="text" id="logement-notary-fees" placeholder="Calcul√© √† 8%" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm" disabled>
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="logement-personal-contribution" class="block text-sm font-medium text-slate-700">Apport personnel (‚Ç¨)</label></div>
                                    <input type="text" id="logement-personal-contribution" value="16000" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between"><label for="logement-loan-rate" class="block text-sm font-medium text-slate-700">Taux du cr√©dit (%)</label></div>
                                    <div class="flex items-center justify-between"><span></span><div class="flex items-center"><span id="logement-loan-rate-status" class="text-xs text-slate-500 mr-2">Auto</span><label class="inline-flex relative items-center cursor-pointer"><input type="checkbox" id="logement-toggle-loan-rate" class="sr-only peer"><div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label></div></div>
                                    <input type="number" id="logement-loan-rate" value="3.15" step="0.01" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm" disabled>
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="logement-loan-insurance-rate" class="block text-sm font-medium text-slate-700">Taux d'assurance cr√©dit (%)</label></div>
                                    <input type="number" id="logement-loan-insurance-rate" value="0.35" step="0.01" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="logement-loan-duration" class="block text-sm font-medium text-slate-700">Dur√©e du cr√©dit (ann√©es)</label></div>
                                    <select id="logement-loan-duration" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                        <option value="10">10 ans</option><option value="15">15 ans</option><option value="20" selected>20 ans</option><option value="25">25 ans</option>
                                    </select>
                                </div>
                                <h3 class="text-lg font-semibold pt-4 mt-4 border-t">Charges Annuelles</h3>
                                <div>
                                    <div class="flex items-center justify-between"><label for="logement-property-tax" class="block text-sm font-medium text-slate-700">Taxe fonci√®re (‚Ç¨)</label></div>
                                    <input type="text" id="logement-property-tax" value="800" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="logement-co-ownership-charges" class="block text-sm font-medium text-slate-700">Charges copro. non r√©cup√©rables (‚Ç¨)</label></div>
                                    <input type="number" id="logement-co-ownership-charges" value="400" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="logement-pno-insurance" class="block text-sm font-medium text-slate-700">Assurance PNO (‚Ç¨)</label></div>
                                    <input type="number" id="logement-pno-insurance" value="120" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="logement-management-fees" class="block text-sm font-medium text-slate-700">Frais de gestion locative (%)</label><div data-tooltip="Pourcentage des loyers encaiss√©s. Mettre 0 si vous g√©rez vous-m√™me."></div></div>
                                    <input type="number" id="logement-management-fees" value="7" step="0.5" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div class="form-actions pt-6 border-t"></div>
                            </form>
                        </div>

                        <div id="form-cave-wrapper" class="hidden">
                            <h2 class="text-xl font-bold mb-6 border-b pb-3">Investissement Cave / Box üì¶</h2>
                            <form id="investment-form-cave" class="space-y-4">
                                <div>
                                    <div class="flex items-center justify-between"><label for="cave-city-name" class="block text-sm font-medium text-slate-700">Nom de la Ville</label><div data-tooltip="Nom de la ville o√π se situe le bien."></div></div>
                                    <input type="text" id="cave-city-name" value="Bordeaux" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="cave-announcement-link" class="block text-sm font-medium text-slate-700">Lien de l'annonce</label><div data-tooltip="Optionnel : collez ici le lien de l'annonce."></div></div>
                                    <input type="url" id="cave-announcement-link" placeholder="https://..." class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <h3 class="text-lg font-semibold pt-4 mt-4 border-t">D√©tails du bien</h3>
                                <div>
                                    <div class="flex items-center justify-between"><label for="cave-purchase-price" class="block text-sm font-medium text-slate-700">Prix affich√© du lot (‚Ç¨)</label></div>
                                    <input type="text" id="cave-purchase-price" value="30000" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="cave-negotiation-rate" class="block text-sm font-medium text-slate-700">N√©gociation sur le prix (%)</label></div>
                                    <input type="number" id="cave-negotiation-rate" value="7" step="0.1" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="cave-count" class="block text-sm font-medium text-slate-700">Nombre de caves / box</label></div>
                                    <input type="number" id="cave-count" value="10" min="1" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="cave-rent-per-unit" class="block text-sm font-medium text-slate-700">Loyer mensuel / unit√© (‚Ç¨)</label></div>
                                    <input type="number" id="cave-rent-per-unit" value="45" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <h3 class="text-lg font-semibold pt-4 mt-4 border-t">Fiscalit√©</h3>
                                <div>
                                    <div class="flex items-center justify-between"><label for="cave-tax-regime" class="block text-sm font-medium text-slate-700">R√©gime d'imposition</label></div>
                                    <select id="cave-tax-regime" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                        <option value="none">Pas d'imposition</option><option value="micro" selected>Micro-BIC</option><option value="reel">R√©gime R√©el</option>
                                    </select>
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="cave-tmi" class="block text-sm font-medium text-slate-700">TMI (%)</label></div>
                                    <select id="cave-tmi" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                        <option value="0">0 %</option><option value="11">11 %</option><option value="30" selected>30 %</option><option value="41">41 %</option><option value="45">45 %</option>
                                    </select>
                                </div>
                                <h3 class="text-lg font-semibold pt-4 mt-4 border-t">Param√®tres d'√âvolution</h3>
                                <div>
                                    <div class="flex items-center justify-between"><label for="cave-appreciation-rate" class="block text-sm font-medium text-slate-700">Revalorisation annuelle du lot (%)</label></div>
                                    <input type="number" id="cave-appreciation-rate" value="1" step="0.1" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="cave-rent-increase-rate" class="block text-sm font-medium text-slate-700">Revalorisation annuelle loyers (%)</label></div>
                                    <input type="number" id="cave-rent-increase-rate" value="2" step="0.1" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="cave-charges-increase-rate" class="block text-sm font-medium text-slate-700">Revalorisation annuelle charges (%)</label></div>
                                    <input type="number" id="cave-charges-increase-rate" value="1.5" step="0.1" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <h3 class="text-lg font-semibold pt-4 mt-4 border-t">Param√®tres du Financement</h3>
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between"><label for="cave-notary-fees" class="block text-sm font-medium text-slate-700">Frais de notaire (‚Ç¨)</label><div data-tooltip="Calcul√©s automatiquement √† 15% du prix n√©goci√©."></div></div>
                                    <div class="flex items-center justify-between"><span></span><div class="flex items-center"><span class="text-xs text-slate-500 mr-2">Manuelle</span><label for="cave-toggle-notary-fees" class="inline-flex relative items-center cursor-pointer"><input type="checkbox" id="cave-toggle-notary-fees" class="sr-only peer"><div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label></div></div>
                                    <input type="text" id="cave-notary-fees" placeholder="Calcul√© √† 15%" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm" disabled>
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="cave-personal-contribution" class="block text-sm font-medium text-slate-700">Apport personnel (‚Ç¨)</label></div>
                                    <input type="text" id="cave-personal-contribution" value="0" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between"><label for="cave-loan-rate" class="block text-sm font-medium text-slate-700">Taux du cr√©dit (%)</label></div>
                                    <div class="flex items-center justify-between"><span></span><div class="flex items-center"><span id="cave-loan-rate-status" class="text-xs text-slate-500 mr-2">Auto</span><label class="inline-flex relative items-center cursor-pointer"><input type="checkbox" id="cave-toggle-loan-rate" class="sr-only peer"><div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label></div></div>
                                    <input type="number" id="cave-loan-rate" value="3.05" step="0.01" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm" disabled>
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="cave-loan-insurance-rate" class="block text-sm font-medium text-slate-700">Taux d'assurance cr√©dit (%)</label></div>
                                    <input type="number" id="cave-loan-insurance-rate" value="0.35" step="0.01" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="cave-loan-duration" class="block text-sm font-medium text-slate-700">Dur√©e du cr√©dit (ann√©es)</label></div>
                                    <select id="cave-loan-duration" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                        <option value="10">10 ans</option><option value="15" selected>15 ans</option><option value="20">20 ans</option><option value="25">25 ans</option>
                                    </select>
                                </div>
                                <h3 class="text-lg font-semibold pt-4 mt-4 border-t">Charges Annuelles</h3>
                                <div class="space-y-2 pt-2">
                                    <div class="flex items-center justify-between"><label for="cave-property-tax" class="block text-sm font-medium text-slate-700">Taxe fonci√®re (‚Ç¨)</label><div data-tooltip="Calcul√©e par d√©faut sur 1 mois de loyer total."></div></div>
                                    <div class="flex items-center justify-between"><span></span><div class="flex items-center"><span class="text-xs text-slate-500 mr-2">Manuelle</span><label for="cave-toggle-property-tax" class="inline-flex relative items-center cursor-pointer"><input type="checkbox" id="cave-toggle-property-tax" class="sr-only peer"><div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label></div></div>
                                    <input type="text" id="cave-property-tax" placeholder="Calcul√©e sur 1 mois de loyer" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm" disabled>
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="cave-co-ownership-charges" class="block text-sm font-medium text-slate-700">Charges copro. mensuelles / unit√© (‚Ç¨)</label></div>
                                    <input type="number" id="cave-co-ownership-charges" value="5" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between"><label for="cave-pno-insurance" class="block text-sm font-medium text-slate-700">Assurance PNO annuelle / unit√© (‚Ç¨)</label></div>
                                    <input type="number" id="cave-pno-insurance" value="15" class="mt-1 block w-full bg-slate-100 border-transparent rounded-lg shadow-sm">
                                </div>
                                <div class="form-actions pt-6 border-t"></div>
                            </form>
                        </div>
                    </div>
                </div>

                <div id="results-section" class="md:col-span-2 space-y-6" style="display: none;">
                    <div class="no-print text-right">
                        <button type="button" id="print-btn" class="bg-gray-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-800 transition duration-300 shadow-md inline-flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd"></path></svg>
                            Imprimer (PDF)
                        </button>
                    </div>
                     <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-bold mb-4">Synth√®se du Financement</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                             <div class="bg-slate-100 p-4 rounded-lg">
                                <p class="text-sm text-slate-600">Co√ªt total du projet</p>
                                <p id="total-project-cost" class="text-2xl font-semibold"></p>
                                 <p class="text-xs text-slate-500">(Achat + Frais + Travaux)</p>
                             </div>
                            <div class="bg-slate-100 p-4 rounded-lg">
                                <p class="text-sm text-slate-600">Montant total emprunt√©</p>
                                <p id="total-loan" class="text-2xl font-semibold"></p>
                            </div>
                            <div class="bg-slate-100 p-4 rounded-lg">
                                <p class="text-sm text-slate-600">Mensualit√© du cr√©dit</p>
                                <p id="monthly-payment" class="text-2xl font-semibold"></p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-bold mb-4">Analyse du Cash Flow (Ann√©e 1)</h2>
                         <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                            <div class="bg-green-50 p-3 rounded-lg text-center">
                                <p class="text-sm text-green-800">Revenus Mensuels</p>
                                <p id="monthly-income" class="text-lg font-bold text-green-900"></p>
                            </div>
                            <div class="bg-red-50 p-3 rounded-lg text-center">
                                <p class="text-sm text-red-800">D√©penses Mensuelles</p>
                                <p id="monthly-expenses" class="text-lg font-bold text-red-900"></p>
                            </div>
                             <div class="bg-red-100 p-3 rounded-lg text-center">
                                <p class="text-sm text-red-800">Imp√¥t sur le Revenu /m</p>
                                <p id="monthly-tax" class="text-lg font-bold text-red-900"></p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-center mt-6">
                            <div id="monthly-cf-card" class="result-card p-4 rounded-lg">
                                <p class="text-sm">Cash Flow Net Mensuel</p>
                                <p id="monthly-cashflow" class="text-3xl font-bold"></p>
                            </div>
                            <div id="annual-cf-card" class="result-card p-4 rounded-lg">
                                <p class="text-sm">Cash Flow Net Annuel</p>
                                <p id="annual-cashflow" class="text-3xl font-bold"></p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-bold mb-4">√âvolution Annuelle du Cash Flow</h2>
                        <div class="overflow-x-auto max-h-[400px] printable-table-container">
                            <table class="w-full text-sm text-left text-slate-500">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0">
                                    <tr>
                                        <th class="px-2 py-3 rounded-l-lg">An</th>
                                        <th class="px-2 py-3">Revenus</th>
                                        <th class="px-2 py-3">CF Brut</th>
                                        <th class="px-2 py-3">Imp√¥t</th>
                                        <th class="px-2 py-3">CF Net</th>
                                        <th class="px-2 py-3 rounded-r-lg">CF Net /m</th>
                                    </tr>
                                </thead>
                                <tbody id="cashflow-evolution-table"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-bold mb-4">Analyse de la Revente et Plus-Value</h2>
                        <div class="overflow-x-auto max-h-[400px] printable-table-container">
                            <table class="w-full text-sm text-left text-slate-500">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-3 rounded-l-lg">Ann√©e</th>
                                        <th class="px-4 py-3">Valeur du Bien</th>
                                        <th class="px-4 py-3">Plus-Value Nette</th>
                                        <th class="px-4 py-3 rounded-r-lg">PV Nette (%)</th>
                                    </tr>
                                </thead>
                                <tbody id="resale-analysis-table"></tbody>
                            </table>
                        </div>
                    </div>
                     <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 id="final-balance-title" class="text-xl font-bold mb-4">Bilan Final de l'Op√©ration</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-center">
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <p class="text-sm text-slate-600">Total des Cash Flows Nets cumul√©s</p>
                                <p id="total-cashflow" class="text-2xl font-semibold"></p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <p class="text-sm text-slate-600">Plus-Value Nette √† la revente</p>
                                <p id="final-net-gain" class="text-2xl font-semibold"></p>
                            </div>
                        </div>
                        <div class="mt-4 bg-blue-50 p-4 rounded-lg text-center">
                             <p class="text-sm text-blue-800">B√©n√©fice Total de l'Op√©ration (‚Ç¨)</p>
                             <p id="total-profit-euros" class="text-3xl font-bold text-blue-900"></p>
                        </div>
                         <div class="mt-4 bg-blue-50 p-4 rounded-lg text-center">
                             <p class="text-sm text-blue-800">B√©n√©fice Total de l'Op√©ration (%)</p>
                             <p id="total-profit-percent" class="text-3xl font-bold text-blue-900"></p>
                             <p class="text-xs text-slate-500">(par rapport au co√ªt total d'acquisition)</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg border-2 border-blue-500">
                        <h2 id="final-balance-title-30" class="text-xl font-bold mb-4 text-blue-700">Bilan Final de l'Op√©ration (Vente √† 30 ans)</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-center">
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <p class="text-sm text-slate-600">Total des Cash Flows Nets cumul√©s</p>
                                <p id="total-cashflow-30" class="text-2xl font-semibold"></p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <p class="text-sm text-slate-600">Plus-Value Nette √† la revente</p>
                                <p id="final-net-gain-30" class="text-2xl font-semibold"></p>
                            </div>
                        </div>
                        <div class="mt-4 bg-blue-50 p-4 rounded-lg text-center">
                             <p class="text-sm text-blue-800">B√©n√©fice Total de l'Op√©ration (‚Ç¨)</p>
                             <p id="total-profit-euros-30" class="text-3xl font-bold text-blue-900"></p>
                        </div>
                         <div class="mt-4 bg-blue-50 p-4 rounded-lg text-center">
                             <p class="text-sm text-blue-800">B√©n√©fice Total de l'Op√©ration (%)</p>
                             <p id="total-profit-percent-30" class="text-3xl font-bold text-blue-900"></p>
                             <p class="text-xs text-slate-500">(par rapport au co√ªt total d'acquisition)</p>
                        </div>
                    </div>
                </div>
            </main>
            
            <section id="saved-simulations-section" class="mt-12 no-print">
                 <div class="flex flex-wrap items-center justify-between mb-6 border-b pb-3">
                    <h2 class="text-2xl font-bold text-slate-900">Mes Simulations</h2>
                    <div id="sort-controls" class="flex items-center gap-2 sm:gap-4">
                        <span class="text-sm font-medium text-slate-700 hidden sm:block">Trier par:</span>
                        <button data-sort="date" class="sort-btn text-sm bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-3 rounded-lg transition active">Date</button>
                        <button data-sort="name" class="sort-btn text-sm bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-3 rounded-lg transition">Nom</button>
                        <button data-sort="investment" class="sort-btn text-sm bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-3 rounded-lg transition">Investissement</button>
                        <button data-sort="profit" class="sort-btn text-sm bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-3 rounded-lg transition">B√©n√©fice %</button>
                    </div>
                </div>
                <div id="simulations-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                 <p id="no-simulations-message" class="text-slate-500 bg-white p-6 rounded-2xl shadow text-center">Aucune simulation sauvegard√©e.</p>
            </section>
            <section id="top-investments-section" class="mt-12 no-print">
                <h2 class="text-2xl font-bold text-slate-900 mb-6 border-b pb-3">üèÜ Top 3 des Investissements</h2>
                <div id="top-investments-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <p id="not-enough-simulations-message" class="text-slate-500 bg-white p-6 rounded-2xl shadow text-center" style="display: none;">Sauvegardez au moins une simulation pour voir le classement.</p>
            </section>
		</div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script>
        // IMPORTANT: REMPLACEZ CE BLOC PAR VOTRE PROPRE CONFIGURATION FIREBASE
   
      const firebaseConfig = {
        apiKey: "AIzaSyB4780iRxAhvjUUi-FHf08dXvlOMNWFWe0",
        authDomain: "simulateur-parking-app.firebaseapp.com",
        projectId: "simulateur-parking-app",
        storageBucket: "simulateur-parking-app.firebasestorage.app",
        messagingSenderId: "5729529939",
        appId: "1:5729529939:web:c4af96400a826998ab16a6"
      };
        // FIN DU BLOC √Ä REMPLACER

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
      
        let currentUser = null;
        let allUserSimulations = [];
        let unsubscribeSimulations = null;
        let currentInvestmentType = null;

        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (value) => new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(isNaN(value) ? 0 : value);
        const formatPercent = (value) => `${(isNaN(value) ? 0 : value).toFixed(2)} %`;
        const parseFormattedNumber = (str) => {
            if (typeof str !== 'string' || str.trim() === '') return 0;
            return parseFloat(str.replace(/\s/g, '').replace(',', '.')) || 0;
        }
        
        const toggleUI = (toggle, input, placeholderEnabled, placeholderDisabled) => {
            input.disabled = !toggle.checked;
            if (placeholderEnabled !== null) input.placeholder = toggle.checked ? placeholderEnabled : placeholderDisabled;
        };

        // --- TAX CALCULATION LOGIC ---
        function calculateTaxes(annualIncome, annualCharges, annualLoanInterest, taxRegime, tmiRate, managementFees = 0) {
            if (taxRegime === 'none' || tmiRate === 0) return { tax: 0 };
            const socialContributionsRate = 0.172;
            const tmi = tmiRate / 100;
            let taxableBase = 0;
            if (taxRegime === 'micro') {
                taxableBase = annualIncome * 0.50;
            } else if (taxRegime === 'reel') {
                const deductibleCharges = annualCharges + annualLoanInterest + managementFees;
                taxableBase = annualIncome - deductibleCharges;
            }
            if (taxableBase <= 0) return { tax: 0 };
            return { tax: taxableBase * (tmi + socialContributionsRate) };
        }

        function calculateCapitalGainsTax(grossGain, holdingYear) {
            if (grossGain <= 0) return { tax: 0, netGain: grossGain };
            const INCOME_TAX_RATE = 0.19, SOCIAL_TAX_RATE = 0.172;
            let incomeTaxAllowanceRate = 0;
            if (holdingYear > 5) {
                if (holdingYear <= 21) incomeTaxAllowanceRate = (holdingYear - 5) * 0.06;
                else if (holdingYear === 22) incomeTaxAllowanceRate = (16 * 0.06) + 0.04; 
                else incomeTaxAllowanceRate = 1;
            }
            let socialTaxAllowanceRate = 0;
            if (holdingYear > 5) {
                if (holdingYear <= 21) socialTaxAllowanceRate = (holdingYear - 5) * 0.0165;
                else if (holdingYear === 22) socialTaxAllowanceRate = (16 * 0.0165) + 0.0160;
                else if (holdingYear <= 30) socialTaxAllowanceRate = (16 * 0.0165) + 0.0160 + ((holdingYear - 22) * 0.09);
                else socialTaxAllowanceRate = 1;
            }
            const taxableIncomeBase = grossGain * (1 - incomeTaxAllowanceRate);
            const taxableSocialBase = grossGain * (1 - socialTaxAllowanceRate);
            const totalTax = (taxableIncomeBase * INCOME_TAX_RATE) + (taxableSocialBase * SOCIAL_TAX_RATE);
            return { tax: totalTax, netGain: grossGain - totalTax };
        }

        // --- DOM ELEMENTS ---
        const formElements = {
            parking: {
                form: document.getElementById('investment-form-parking'),
                cityName: document.getElementById('parking-city-name'),
                announcementLink: document.getElementById('parking-announcement-link'),
                purchasePrice: document.getElementById('parking-purchase-price'),
                negotiationRate: document.getElementById('parking-negotiation-rate'),
                spacesCount: document.getElementById('parking-spaces-count'),
                rentPerSpace: document.getElementById('parking-rent-per-space'),
                taxRegime: document.getElementById('parking-tax-regime'),
                tmi: document.getElementById('parking-tmi'),
                appreciationRate: document.getElementById('parking-appreciation-rate'),
                rentIncreaseRate: document.getElementById('parking-rent-increase-rate'),
                chargesIncreaseRate: document.getElementById('parking-charges-increase-rate'),
                toggleNotaryFees: document.getElementById('parking-toggle-notary-fees'),
                notaryFees: document.getElementById('parking-notary-fees'),
                personalContribution: document.getElementById('parking-personal-contribution'),
                toggleLoanRate: document.getElementById('parking-toggle-loan-rate'),
                loanRate: document.getElementById('parking-loan-rate'),
                loanInsuranceRate: document.getElementById('parking-loan-insurance-rate'),
                loanDuration: document.getElementById('parking-loan-duration'),
                pnoInsurance: document.getElementById('parking-pno-insurance'),
                coOwnershipCharges: document.getElementById('parking-co-ownership-charges'),
                togglePropertyTax: document.getElementById('parking-toggle-property-tax'),
                propertyTax: document.getElementById('parking-property-tax'),
                electrificationCostPerSpace: document.getElementById('parking-electrification-cost-per-space'),
                electrificationSpacesCount: document.getElementById('parking-electrification-spaces-count'),
                electrificationYear: document.getElementById('parking-electrification-year'),
                newRentPerSpace: document.getElementById('parking-new-rent-per-space'),
            },
            logement: {
                form: document.getElementById('investment-form-logement'),
                cityName: document.getElementById('logement-city-name'),
                announcementLink: document.getElementById('logement-announcement-link'),
                purchasePrice: document.getElementById('logement-purchase-price'),
                agencyFees: document.getElementById('logement-agency-fees'),
                negotiationRate: document.getElementById('logement-negotiation-rate'),
                worksCost: document.getElementById('logement-works-cost'),
                monthlyRentHc: document.getElementById('logement-monthly-rent-hc'),
                monthlyCharges: document.getElementById('logement-monthly-charges'),
                vacancyRate: document.getElementById('logement-vacancy-rate'),
                taxRegime: document.getElementById('logement-tax-regime'),
                tmi: document.getElementById('logement-tmi'),
                appreciationRate: document.getElementById('logement-appreciation-rate'),
                rentIncreaseRate: document.getElementById('logement-rent-increase-rate'),
                chargesIncreaseRate: document.getElementById('logement-charges-increase-rate'),
                			investmentHorizon: document.getElementById('logement-investment-horizon'),
                toggleNotaryFees: document.getElementById('logement-toggle-notary-fees'),
                notaryFees: document.getElementById('logement-notary-fees'),
                personalContribution: document.getElementById('logement-personal-contribution'),
                toggleLoanRate: document.getElementById('logement-toggle-loan-rate'),
                loanRate: document.getElementById('logement-loan-rate'),
                loanInsuranceRate: document.getElementById('logement-loan-insurance-rate'),
                loanDuration: document.getElementById('logement-loan-duration'),
                propertyTax: document.getElementById('logement-property-tax'),
                coOwnershipCharges: document.getElementById('logement-co-ownership-charges'),
                pnoInsurance: document.getElementById('logement-pno-insurance'),
                managementFees: document.getElementById('logement-management-fees'),
            },
            cave: {
                form: document.getElementById('investment-form-cave'),
                cityName: document.getElementById('cave-city-name'),
                announcementLink: document.getElementById('cave-announcement-link'),
                purchasePrice: document.getElementById('cave-purchase-price'),
                negotiationRate: document.getElementById('cave-negotiation-rate'),
                count: document.getElementById('cave-count'),
                rentPerUnit: document.getElementById('cave-rent-per-unit'),
                taxRegime: document.getElementById('cave-tax-regime'),
                tmi: document.getElementById('cave-tmi'),
                appreciationRate: document.getElementById('cave-appreciation-rate'),
                rentIncreaseRate: document.getElementById('cave-rent-increase-rate'),
                chargesIncreaseRate: document.getElementById('cave-charges-increase-rate'),
                toggleNotaryFees: document.getElementById('cave-toggle-notary-fees'),
                notaryFees: document.getElementById('cave-notary-fees'),
                personalContribution: document.getElementById('cave-personal-contribution'),
                toggleLoanRate: document.getElementById('cave-toggle-loan-rate'),
                loanRate: document.getElementById('cave-loan-rate'),
                loanInsuranceRate: document.getElementById('cave-loan-insurance-rate'),
                loanDuration: document.getElementById('cave-loan-duration'),
                togglePropertyTax: document.getElementById('cave-toggle-property-tax'),
                propertyTax: document.getElementById('cave-property-tax'),
                coOwnershipCharges: document.getElementById('cave-co-ownership-charges'),
                pnoInsurance: document.getElementById('cave-pno-insurance'),
            }
        };

        // --- UI NAVIGATION & ROUTING ---
        function showSimulator(type, shouldRunSimulation = true) {
            currentInvestmentType = type;
            document.getElementById('project-selector').classList.add('hidden');
            document.getElementById('simulator-container').classList.remove('hidden');
            document.getElementById('simulator-container').classList.add('grid');
            
            Object.keys(formElements).forEach(key => {
                const wrapper = document.getElementById(`form-${key}-wrapper`);
                if (key === type) {
                    wrapper.classList.remove('hidden');
                } else {
                    wrapper.classList.add('hidden');
                }
            });
            
            if (shouldRunSimulation) {
                fetchExcellentRate(); 
                runSimulation();
            }
        }

        function showSelector() {
            currentInvestmentType = null;
            document.getElementById('project-selector').classList.remove('hidden');
            document.getElementById('simulator-container').classList.add('hidden');
            document.getElementById('simulator-container').classList.remove('grid');
            document.getElementById('results-section').style.display = 'none';
        }

        function runSimulation() {
            if (!currentInvestmentType) return;
            let results;
            switch(currentInvestmentType) {
                case 'parking':  results = runParkingSimulation(); break;
                case 'logement': results = runLogementSimulation(); break;
                case 'cave':     results = runCaveSimulation(); break;
            }
            if (results) {
                displayResults(results);
            }
            return results;
        }

        // --- SIMULATION LOGIC ---
        function getFormValues(type) {
            const values = {};
            const elements = formElements[type];
            for (const key in elements) {
                if (key === 'form') continue;
                const el = elements[key];
                if (el.type === 'checkbox') {
                    values[key] = el.checked;
                } else if (el.tagName === 'SELECT' || el.type === 'url' || (el.type === 'text' && isNaN(parseFormattedNumber(el.value)))) {
                    values[key] = el.value;
                } else {
                    values[key] = parseFormattedNumber(el.value);
                }
            }
            return values;
        }

        function runParkingSimulation() {
            const values = getFormValues('parking');
            if (isNaN(values.purchasePrice) || isNaN(values.spacesCount) || values.spacesCount === 0) return;

            const negotiatedPurchasePrice = values.purchasePrice * (1 - (values.negotiationRate / 100));
            let notaryFees = values.toggleNotaryFees && values.notaryFees > 0 ? values.notaryFees : (negotiatedPurchasePrice * 0.12);
            const totalWorkCost = values.electrificationCostPerSpace * values.electrificationSpacesCount;
            const totalAcquisitionCost = negotiatedPurchasePrice + notaryFees + totalWorkCost;
            
            return calculateFinancials({
                ...values,
                negotiatedPurchasePrice,
                notaryFees,
                totalWorkCost,
                totalAcquisitionCost,
                getAnnualIncome: (year, rents) => {
                    return (year < values.electrificationYear || values.electrificationSpacesCount === 0) 
                        ? (values.spacesCount * rents.standard) * 12
                        : (((values.spacesCount - values.electrificationSpacesCount) * rents.standard) + (values.electrificationSpacesCount * rents.special)) * 12;
                },
                getInitialCharges: () => {
                    const annualPno = values.pnoInsurance * values.spacesCount;
                    const annualCopro = (values.coOwnershipCharges * values.spacesCount) * 12;
                    const initialMonthlyIncome = values.spacesCount * values.rentPerSpace;
                    const annualPropertyTax = values.togglePropertyTax && values.propertyTax > 0 ? values.propertyTax : initialMonthlyIncome;
                    return { pno: annualPno, copro: annualCopro, propertyTax: annualPropertyTax, useStaticPropertyTax: values.togglePropertyTax };
                },
                initialRents: { standard: values.rentPerSpace, special: values.newRentPerSpace || values.rentPerSpace }
            });
        }

        function runLogementSimulation() {
            const values = getFormValues('logement');
            const priceBeforeNego = values.purchasePrice * (1 + values.agencyFees / 100);
            const negotiatedPurchasePrice = priceBeforeNego * (1 - (values.negotiationRate / 100));
            let notaryFees = values.toggleNotaryFees && values.notaryFees > 0 ? values.notaryFees : (negotiatedPurchasePrice * 0.08);
            const totalAcquisitionCost = negotiatedPurchasePrice + notaryFees + values.worksCost;

            return calculateFinancials({
                ...values,
                negotiatedPurchasePrice,
                notaryFees,
                totalWorkCost: values.worksCost,
                totalAcquisitionCost,
                getAnnualIncome: (year, rents) => (rents.standard * 12) * (1 - values.vacancyRate / 100),
                getInitialCharges: () => ({ pno: values.pnoInsurance, copro: values.coOwnershipCharges, propertyTax: values.propertyTax, useStaticPropertyTax: true }),
                getManagementFees: (annualIncome) => annualIncome * (values.managementFees / 100),
                initialRents: { standard: values.monthlyRentHc + values.monthlyCharges, special: 0 }
            });
        }

        function runCaveSimulation() {
            const values = getFormValues('cave');
            if (isNaN(values.purchasePrice) || isNaN(values.count) || values.count === 0) return;

            const negotiatedPurchasePrice = values.purchasePrice * (1 - (values.negotiationRate / 100));
            let notaryFees = values.toggleNotaryFees && values.notaryFees > 0 ? values.notaryFees : (negotiatedPurchasePrice * 0.15);
            const totalAcquisitionCost = negotiatedPurchasePrice + notaryFees;

             return calculateFinancials({
                ...values,
                negotiatedPurchasePrice,
                notaryFees,
                totalWorkCost: 0,
                totalAcquisitionCost,
                getAnnualIncome: (year, rents) => values.count * rents.standard * 12,
                getInitialCharges: () => {
                    const annualPno = values.pnoInsurance * values.count;
                    const annualCopro = (values.coOwnershipCharges * values.count) * 12;
                    const initialMonthlyIncome = values.count * values.rentPerUnit;
                    const annualPropertyTax = values.togglePropertyTax && values.propertyTax > 0 ? values.propertyTax : initialMonthlyIncome;
                    return { pno: annualPno, copro: annualCopro, propertyTax: annualPropertyTax, useStaticPropertyTax: values.togglePropertyTax };
                },
                initialRents: { standard: values.rentPerUnit, special: 0 }
            });
        }

function calculateFinancials(params) {
    const {
        negotiatedPurchasePrice, totalAcquisitionCost, personalContribution,
        loanRate, loanDuration, loanInsuranceRate, appreciationRate, rentIncreaseRate, chargesIncreaseRate,
        taxRegime, tmi, getAnnualIncome, getInitialCharges, getManagementFees, initialRents,
        investmentHorizon
    } = params;

    const totalLoanAmount = totalAcquisitionCost > personalContribution ? totalAcquisitionCost - personalContribution : 0;
    const monthlyRate = loanRate / 100 / 12;
    const numberOfPayments = loanDuration * 12;
    let monthlyPayment = 0;
    if (totalLoanAmount > 0 && monthlyRate > 0 && numberOfPayments > 0) {
        monthlyPayment = totalLoanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) / (Math.pow(1 + monthlyRate, numberOfPayments) - 1);
    }
    const monthlyInsurance = totalLoanAmount * (loanInsuranceRate / 100 / 12);
    const totalMonthlyPayment = monthlyPayment + monthlyInsurance;

    const initialCharges = getInitialCharges();
    let currentAnnualPno = initialCharges.pno;
    let currentAnnualCopro = initialCharges.copro;
    let currentAnnualPropertyTax = initialCharges.propertyTax;
    let currentRents = { ...initialRents };

    // D√âCLARATION INITIALE
    let totalNetCashflowOverLoanTerm = 0;
    let totalNetCashflowOverHorizon = 0;
    let finalNetGainAtLoanEnd = 0;
    let finalNetGainAtHorizon = 0;
    let evolution = [];
    let remainingCapital = totalLoanAmount;

    // La boucle g√©n√®re les donn√©es pour le tableau
    for (let year = 1; year <= 30; year++) {
        const annualIncome = getAnnualIncome(year, currentRents);
        const annualManagementFees = getManagementFees ? getManagementFees(annualIncome) : 0;
        
        let annualTaxForYear = initialCharges.useStaticPropertyTax ? currentAnnualPropertyTax : getAnnualIncome(year, currentRents) / 12 * (1 - (params.vacancyRate || 0) / 100);
        let annualDeductibleCharges = currentAnnualPno + currentAnnualCopro + annualTaxForYear;
        
        let annualLoanInterest = 0;
        if (year <= loanDuration && totalLoanAmount > 0) {
            for(let i=0; i<12; i++) {
                let interest = remainingCapital * monthlyRate;
                annualLoanInterest += interest;
                remainingCapital -= (monthlyPayment - interest);
            }
        }
        
        const { tax: annualTax } = calculateTaxes(annualIncome, annualDeductibleCharges, annualLoanInterest, taxRegime, tmi, annualManagementFees);
        const paymentForYear = (year <= loanDuration) ? totalMonthlyPayment * 12 : 0;
        const annualTotalCharges = annualDeductibleCharges + annualManagementFees;
        const annualGrossCashflow = annualIncome - paymentForYear - annualTotalCharges;
        const annualNetCashflow = annualGrossCashflow - annualTax;

        if (year <= loanDuration) {
            totalNetCashflowOverLoanTerm += annualNetCashflow;
        }
        if (year <= investmentHorizon) {
            totalNetCashflowOverHorizon += annualNetCashflow;
        }
        
        const lotValue = negotiatedPurchasePrice * Math.pow(1 + (appreciationRate / 100), year);
        const { netGain } = calculateCapitalGainsTax(lotValue - negotiatedPurchasePrice, year);
        
        // POINT CRUCIAL : C'est ici que les valeurs pour le bilan sont captur√©es
        if(year === loanDuration) {
            finalNetGainAtLoanEnd = netGain;
        }
        if(year === investmentHorizon) {
            finalNetGainAtHorizon = netGain;
        }

        evolution.push({ year, annualIncome, annualGrossCashflow, annualTax, annualNetCashflow, lotValue, netGain });
        
        currentRents.standard *= (1 + rentIncreaseRate / 100);
        if (currentRents.special > 0) currentRents.special *= (1 + rentIncreaseRate / 100);
        
        currentAnnualPno *= (1 + chargesIncreaseRate / 100);
        currentAnnualCopro *= (1 + chargesIncreaseRate / 100);
        if (initialCharges.useStaticPropertyTax) currentAnnualPropertyTax *= (1 + chargesIncreaseRate / 100);
    }

    const y1 = evolution[0];
    const monthlyIncomeY1 = y1.annualIncome / 12;
    const monthlyInitialCharges = (initialCharges.pno + initialCharges.copro + initialCharges.propertyTax + (getManagementFees ? getManagementFees(y1.annualIncome) : 0)) / 12;
    const monthlyExpensesY1 = totalMonthlyPayment + monthlyInitialCharges;
    const monthlyTaxY1 = y1.annualTax / 12;
    const monthlyNetCashflowY1 = monthlyIncomeY1 - monthlyExpensesY1 - monthlyTaxY1;

    // RETOUR FINAL - Les variables captur√©es sont bien retourn√©es ici
    return {
        totalAcquisitionCost, totalLoanAmount, totalMonthlyPayment,
        monthlyIncomeY1, monthlyExpensesY1, monthlyTaxY1, monthlyNetCashflowY1,
        loanDuration, negotiatedPurchasePrice, investmentHorizon,
        totalNetCashflowOverLoanTerm, totalNetCashflowOverHorizon,
        finalNetGainAtLoanEnd, finalNetGainAtHorizon, evolution
    };
}
        
        // --- DISPLAY & RENDER ---
function displayResults(results) {
    if (!results) {
        document.getElementById('results-section').style.display = 'none';
        return;
    }
    document.getElementById('results-section').style.display = 'block';

    // Financing
    document.getElementById('total-project-cost').textContent = formatCurrency(results.totalAcquisitionCost);
    document.getElementById('total-loan').textContent = formatCurrency(results.totalLoanAmount);
    document.getElementById('monthly-payment').textContent = formatCurrency(results.totalMonthlyPayment);
    
    // Y1 Cashflow
    document.getElementById('monthly-income').textContent = formatCurrency(results.monthlyIncomeY1);
    document.getElementById('monthly-expenses').textContent = formatCurrency(results.monthlyExpensesY1);
    document.getElementById('monthly-tax').textContent = formatCurrency(results.monthlyTaxY1);
    document.getElementById('monthly-cashflow').textContent = formatCurrency(results.monthlyNetCashflowY1);
    document.getElementById('annual-cashflow').textContent = formatCurrency(results.monthlyNetCashflowY1 * 12);
    
    const monthlyCfCard = document.getElementById('monthly-cf-card');
    monthlyCfCard.className = 'result-card p-4 rounded-lg transition-colors duration-300';
    if (results.monthlyNetCashflowY1 >= 0) monthlyCfCard.classList.add('bg-green-100', 'text-green-800');
    else monthlyCfCard.classList.add('bg-red-100', 'text-red-800');
    document.getElementById('annual-cf-card').className = monthlyCfCard.className;

    // --- NOUVELLE M√âTHODE DE G√âN√âRATION DES TABLEAUX (createElement) ---
    const cashflowTableBody = document.getElementById('cashflow-evolution-table');
    const resaleTableBody = document.getElementById('resale-analysis-table');

    // Vider les tableaux avant de les remplir
    cashflowTableBody.innerHTML = '';
    resaleTableBody.innerHTML = '';

    results.evolution.forEach(item => {
        // --- Construction du tableau de Cash Flow ---

        // 1. Ajout du bandeau "Fin du pr√™t" si l'ann√©e correspond
        // if (item.year === results.loanDuration + 1) {
            // const bannerRow = document.createElement('tr');
            // bannerRow.className = 'bg-blue-100'; // Style du bandeau bleu pour une meilleure visibilit√©
            // const bannerCell = document.createElement('td');
            // bannerCell.colSpan = 6; // Adapt√© pour les 6 colonnes du tableau de cash-flow
            // bannerCell.className = 'text-center font-bold py-2 text-blue-800';
            // bannerCell.textContent = 'Fin du pr√™t';
            // bannerRow.appendChild(bannerCell);
            // cashflowTableBody.appendChild(bannerRow);
        // }
            if (item.year === 30 && results.loanDuration < 29) {
                const dotsRow = document.createElement('tr');
                dotsRow.className = 'bg-blue-100';
                const dotsCell = document.createElement('td');
                dotsCell.colSpan = 6;
                dotsCell.className = 'text-center font-semibold py-1';
                dotsCell.textContent = 'Fin du pr√™t';
                dotsRow.appendChild(dotsCell);
                cashflowTableBody.appendChild(dotsRow);
            }

        // 2. Cr√©ation de la ligne de donn√©es pour le cash flow
        const cfRow = document.createElement('tr');
        cfRow.className = 'bg-white border-b hover:bg-slate-50 text-xs';
        
        // Cr√©ation et ajout des cellules une par une
        const yearCell = document.createElement('th');
        yearCell.className = 'px-2 py-2 font-medium text-slate-900';
        yearCell.textContent = item.year;
        cfRow.appendChild(yearCell);

        const incomeCell = document.createElement('td');
        incomeCell.className = 'px-2 py-2';
        incomeCell.textContent = formatCurrency(item.annualIncome);
        cfRow.appendChild(incomeCell);

        const grossCfCell = document.createElement('td');
        grossCfCell.className = `px-2 py-2 ${item.annualGrossCashflow >= 0 ? 'text-gray-600' : 'text-orange-600'}`;
        grossCfCell.textContent = formatCurrency(item.annualGrossCashflow);
        cfRow.appendChild(grossCfCell);
        
        const taxCell = document.createElement('td');
        taxCell.className = 'px-2 py-2 text-red-600';
        taxCell.textContent = formatCurrency(item.annualTax);
        cfRow.appendChild(taxCell);

        const netCfCell = document.createElement('td');
        netCfCell.className = `px-2 py-2 font-semibold ${item.annualNetCashflow >= 0 ? 'text-green-600' : 'text-red-600'}`;
        netCfCell.textContent = formatCurrency(item.annualNetCashflow);
        cfRow.appendChild(netCfCell);
        
        const monthlyNetCfCell = document.createElement('td');
        monthlyNetCfCell.className = `px-2 py-2 font-semibold ${item.annualNetCashflow >= 0 ? 'text-green-600' : 'text-red-600'}`;
        monthlyNetCfCell.textContent = formatCurrency(item.annualNetCashflow / 12);
        cfRow.appendChild(monthlyNetCfCell);

        cashflowTableBody.appendChild(cfRow);
        
        // --- Construction du tableau de Revente ---
        if (item.year <= results.loanDuration || item.year === 30) {
            // Ajout de la ligne "Fin du pr√™t" si n√©cessaire
            if (item.year === 30 && results.loanDuration < 29) {
                const dotsRow = document.createElement('tr');
                dotsRow.className = 'bg-blue-100';
                const dotsCell = document.createElement('td');
                dotsCell.colSpan = 4;
                dotsCell.className = 'text-center font-semibold py-1';
                dotsCell.textContent = 'Fin du pr√™t';
                dotsRow.appendChild(dotsCell);
                resaleTableBody.appendChild(dotsRow);
            }

            // Cr√©ation de la ligne de donn√©es pour la revente
            const resaleRow = document.createElement('tr');
            resaleRow.className = 'bg-white border-b hover:bg-slate-50';

            const resaleYearCell = document.createElement('th');
            resaleYearCell.className = 'px-4 py-2 font-medium text-slate-900';
            resaleYearCell.textContent = item.year;
            resaleRow.appendChild(resaleYearCell);

            const lotValueCell = document.createElement('td');
            lotValueCell.className = 'px-4 py-2';
            lotValueCell.textContent = formatCurrency(item.lotValue);
            resaleRow.appendChild(lotValueCell);
            
            const netGainCell = document.createElement('td');
            netGainCell.className = `px-4 py-2 font-semibold ${item.netGain >= 0 ? 'text-green-600' : 'text-red-600'}`;
            netGainCell.textContent = formatCurrency(item.netGain);
            resaleRow.appendChild(netGainCell);

            const netGainPercentCell = document.createElement('td');
            const netGainPercentage = results.negotiatedPurchasePrice > 0 ? (item.netGain / results.negotiatedPurchasePrice) * 100 : 0;
            netGainPercentCell.className = `px-4 py-2 ${netGainPercentage >= 0 ? 'text-green-600' : 'text-red-600'}`;
            netGainPercentCell.textContent = formatPercent(netGainPercentage);
            resaleRow.appendChild(netGainPercentCell);

            resaleTableBody.appendChild(resaleRow);
        
            // Ajout du bandeau "Fin du pr√™t" si l'ann√©e correspond
            if (item.year === results.loanDuration && results.loanDuration < 30) {
                const bannerRow = document.createElement('tr');
                bannerRow.className = 'bg-blue-100';
                const bannerCell = document.createElement('td');
                bannerCell.colSpan = 4;
                bannerCell.className = 'text-center font-bold py-2 text-blue-800';
                bannerCell.textContent = 'Fin du pr√™t';
                bannerRow.appendChild(bannerCell);
                resaleTableBody.appendChild(bannerRow);
            }
        }
    });

    // --- FIN DE LA NOUVELLE M√âTHODE ---

    // Final Balance
    const totalProfitEurosLoanEnd = results.totalNetCashflowOverLoanTerm + results.finalNetGainAtLoanEnd;
    const totalProfitPercentLoanEnd = results.totalAcquisitionCost > 0 ? (totalProfitEurosLoanEnd / results.totalAcquisitionCost) * 100 : 0;
    document.getElementById('final-balance-title').textContent = `Bilan Final de l'Op√©ration (Vente √† ${results.loanDuration} ans)`;
    document.getElementById('total-cashflow').textContent = formatCurrency(results.totalNetCashflowOverLoanTerm);
    document.getElementById('final-net-gain').textContent = formatCurrency(results.finalNetGainAtLoanEnd);
    document.getElementById('total-profit-euros').textContent = formatCurrency(totalProfitEurosLoanEnd);
    document.getElementById('total-profit-percent').textContent = formatPercent(totalProfitPercentLoanEnd);
    
const horizon = sim.data.investmentHorizon || sim.results.loanDuration; // Fallback sur la dur√©e du pr√™t
    const totalProfitEurosHorizon = results.totalNetCashflowOverHorizon + results.finalNetGainAtHorizon;
    const totalProfitPercentHorizon = results.totalAcquisitionCost > 0 ? (totalProfitEurosHorizon / results.totalAcquisitionCost) * 100 : 0;

document.getElementById('final-balance-title-30').textContent = `Bilan Final de l'Op√©ration (Vente √† ${horizon} ans)`;
    document.getElementById('total-cashflow-30').textContent = formatCurrency(results.totalNetCashflowOverHorizon);
    document.getElementById('final-net-gain-30').textContent = formatCurrency(results.finalNetGainAtHorizon);
    document.getElementById('total-profit-euros-30').textContent = formatCurrency(totalProfitEurosHorizon);
    document.getElementById('total-profit-percent-30').textContent = formatPercent(totalProfitPercentHorizon);
}
        // --- DATA & FIRESTORE ---
        const saveSimulationToFirestore = async (simulation) => {
            if (!currentUser) { alert("Erreur : Vous n'√™tes pas connect√©."); return false; }
            try {
                await db.collection('simulations').add({ ...simulation, userId: currentUser.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                return true;
            } catch (error) {
                console.error("Erreur de sauvegarde:", error);
                alert("Une erreur est survenue lors de la sauvegarde.");
                return false;
            }
        };

        const deleteSimulationFromFirestore = async (docId) => {
             if (!currentUser) return;
             try { await db.collection('simulations').doc(docId).delete(); } 
             catch(error) { console.error("Erreur de suppression:", error); }
        }
        
        const renderSimulations = (simsToSort = null) => {
            const sims = simsToSort || allUserSimulations;
            const listEl = document.getElementById('simulations-list');
            const messageEl = document.getElementById('no-simulations-message');
            listEl.innerHTML = '';
            
            if (sims.length === 0) {
                messageEl.style.display = 'block';
            } else {
                messageEl.style.display = 'none';
            }
            renderTopInvestments(sims);
            const icons = { parking: 'üöó', logement: 'üè†', cave: 'üì¶' };

            sims.forEach((sim) => {
                if (!sim.results || !sim.data) return;
                const cashflowClass = sim.results.monthlyNetCashflowY1 >= 0 ? 'text-green-600' : 'text-red-600';
		const profitPercentClass = sim.results.totalProfitPercentHorizon >= 0 ? 'text-blue-600' : 'text-red-600';
                let linkHTML = '';
                const announcementLink = sim.data.announcementLink;
                if (announcementLink) {
                    try { 
                        new URL(announcementLink); 
                        linkHTML = `<a href="${announcementLink}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline text-xs truncate block mt-1">Voir l'annonce</a>`;
                    } catch (_) {}
                }
                const card = document.createElement('div');
                card.className = "simulation-item bg-white p-5 rounded-xl shadow transition duration-300";
card.innerHTML = `
    <h3 class="font-bold text-lg text-slate-800 truncate">${icons[sim.type] || ''} ${sim.data.title}</h3>
    ${linkHTML}
    <div class="mt-3 space-y-2 text-sm">
        <p class="flex justify-between"><span>Investissement:</span> <span class="font-semibold text-slate-700">${formatCurrency(sim.results.totalAcquisitionCost)}</span></p>
        
        <p class="flex justify-between"><span>B√©n√©fice % (${horizon}a):</span> <span class="font-semibold ${profitPercentClass}">${formatPercent(sim.results.totalProfitPercentHorizon)}</span></p>
        
        <p class="flex justify-between"><span>CF Net /m (A1):</span> <span class="font-semibold ${cashflowClass}">${formatCurrency(sim.results.monthlyNetCashflowY1)}</span></p>
    </div>
    <div class="mt-4 flex space-x-2">
        <button data-id="${sim.id}" class="load-sim-btn w-full text-sm bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-3 rounded-lg transition">Charger</button>
        <button data-id="${sim.id}" class="delete-sim-btn w-full text-sm bg-red-100 hover:bg-red-200 text-red-800 font-semibold py-2 px-3 rounded-lg transition">Supprimer</button>
    </div>`;
                listEl.appendChild(card);
            });
        };

        const renderTopInvestments = (sims) => {
            const topListEl = document.getElementById('top-investments-list');
            const messageEl = document.getElementById('not-enough-simulations-message');
            topListEl.innerHTML = '';
            if (sims.length === 0) {
                messageEl.style.display = 'block'; topListEl.style.display = 'none'; return;
            }
            messageEl.style.display = 'none'; topListEl.style.display = 'grid';
            
            const sortedSims = [...sims].filter(s => s.results && s.results.totalProfitPercent30Years !== undefined).sort((a, b) => b.results.totalProfitPercent30Years - a.results.totalProfitPercent30Years);
            const topSims = sortedSims.slice(0, 3);
            const medals = ['ü•á', 'ü•à', 'ü•â'];

            topSims.forEach((sim, index) => {
                const profitPercentClass = sim.results.totalProfitPercent30Years >= 0 ? 'text-blue-600' : 'text-red-600';
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-xl shadow-lg border-2 border-amber-300";
                card.innerHTML = `<h3 class="font-bold text-lg text-slate-800 truncate">${medals[index]} ${sim.data.title}</h3><div class="mt-3 space-y-2 text-sm"><p class="flex justify-between"><span>B√©n√©fice % (30 ans):</span> <span class="font-semibold ${profitPercentClass}">${formatPercent(sim.results.totalProfitPercent30Years)}</span></p><p class="flex justify-between"><span>Investissement:</span> <span class="font-semibold text-slate-700">${formatCurrency(sim.results.totalAcquisitionCost)}</span></p></div>`;
                topListEl.appendChild(card);
            });
        };

        function listenToSimulations() {
            if (unsubscribeSimulations) unsubscribeSimulations();
            if (!currentUser) return;
            unsubscribeSimulations = db.collection('simulations')
                .where('userId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    allUserSimulations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderSimulations(allUserSimulations);
                }, error => console.error("Erreur d'√©coute des simulations:", error));
        }
        
        function fetchExcellentRate() {
            if (!currentInvestmentType) return;
            const currentFormElements = formElements[currentInvestmentType];
            const loanRateInput = currentFormElements.loanRate;
            const loanRateStatus = document.getElementById(`${currentInvestmentType}-loan-rate-status`);
            
            const excellentRatesByDuration = { 10: 2.95, 15: 3.05, 20: 3.15, 25: 3.25, 'default': 3.15 };
            const duration = parseInt(currentFormElements.loanDuration.value, 10) || 0;
            const currentExcellentRate = excellentRatesByDuration[duration] || excellentRatesByDuration['default'];
            
            if (loanRateStatus) loanRateStatus.textContent = 'Auto'; 
            if (!currentFormElements.toggleLoanRate.checked) {
                loanRateInput.value = currentExcellentRate;
            }
        }
        
        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            const tooltipTemplate = document.getElementById('tooltip-template');
            document.querySelectorAll('[data-tooltip]').forEach(el => {
                if (el.children.length > 0 && el.querySelector('.info-icon')) return;
                const tooltipNode = tooltipTemplate.content.cloneNode(true);
                tooltipNode.querySelector('.info-tooltip').textContent = el.dataset.tooltip;
                el.appendChild(tooltipNode);
            });
            
            const authContainer = document.getElementById('auth-container'), appContainer = document.getElementById('app-container');
            const loginForm = document.getElementById('login-form'), signupForm = document.getElementById('signup-form');
            const logoutBtn = document.getElementById('logout-btn'), authError = document.getElementById('auth-error');
            
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    authContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    listenToSimulations();
                } else {
                    currentUser = null;
                    if (unsubscribeSimulations) unsubscribeSimulations();
                    authContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    showSelector();
                }
            });
            
            const handleAuthForm = (form, authMethod) => {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const email = form.querySelector('input[type="email"]').value;
                    const password = form.querySelector('input[type="password"]').value;
                    authMethod.call(auth, email, password).catch(error => {
                        let msg = "Une erreur est survenue. Veuillez r√©essayer.";
                        if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') msg = "Email ou mot de passe incorrect.";
                        else if (error.code === 'auth/weak-password') msg = "Le mot de passe doit faire au moins 6 caract√®res.";
                        else if (error.code === 'auth/email-already-in-use') msg = "Cette adresse e-mail est d√©j√† utilis√©e.";
                        else if (error.code === 'auth/invalid-email') msg = "Le format de l'adresse e-mail est invalide.";
                        authError.textContent = msg;
                        authError.classList.remove('hidden');
                    });
                });
            };
            handleAuthForm(loginForm, auth.signInWithEmailAndPassword);
            handleAuthForm(signupForm, auth.createUserWithEmailAndPassword);
            logoutBtn.addEventListener('click', () => auth.signOut());
            document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); signupForm.classList.remove('hidden'); authError.classList.add('hidden'); });
            document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); signupForm.classList.add('hidden'); loginForm.classList.remove('hidden'); authError.classList.add('hidden'); });
            
            document.getElementById('select-parking').addEventListener('click', () => showSimulator('parking'));
            document.getElementById('select-logement').addEventListener('click', () => showSimulator('logement'));
            document.getElementById('select-cave').addEventListener('click', () => showSimulator('cave'));
            document.getElementById('back-to-selector').addEventListener('click', showSelector);
            
            const actionButtonsHTML = `
                <div class="space-y-2">
                    <div class="flex space-x-2">
                        <button type="button" class="btn-calculate w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md">Calculer</button>
                        <button type="button" class="btn-save w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 shadow-md">Sauvegarder</button>
                    </div>
                    <div>
                        <button type="button" class="btn-new w-full bg-slate-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-600 transition duration-300 shadow-md">Nouvelle simulation</button>
                    </div>
                </div>`;
            document.querySelectorAll('.form-actions').forEach(el => el.innerHTML = actionButtonsHTML);
            
            document.getElementById('form-container').addEventListener('input', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                    if (e.target.id.includes('loan-duration')) fetchExcellentRate();
                     if (e.target.id === 'parking-spaces-count') {
                        const totalSpaces = parseInt(e.target.value, 10) || 0;
                        const dropdown = formElements.parking.electrificationSpacesCount;
                        const currentValue = parseInt(dropdown.value, 10);
                        dropdown.innerHTML = '';
                        for (let i = 0; i <= totalSpaces; i++) {
                            const option = document.createElement('option');
                            option.value = i; option.textContent = i;
                            if (i === currentValue) option.selected = true;
                            dropdown.appendChild(option);
                        }
                        if(currentValue > totalSpaces) dropdown.value = totalSpaces;
                    }
                    runSimulation();
                }
            });

            document.getElementById('form-container').addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    const type = currentInvestmentType;
                    const elId = e.target.id;
                    if (elId.includes('toggle-notary-fees')) {
                        const placeholder = type === 'parking' ? 'Calcul√© √† 12%' : (type === 'logement' ? 'Calcul√© √† 8%' : 'Calcul√© √† 15%');
                        toggleUI(e.target, formElements[type].notaryFees, "Montant manuel (‚Ç¨)", placeholder);
                    } else if (elId.includes('toggle-property-tax')) {
                        toggleUI(e.target, formElements[type].propertyTax, "Montant annuel manuel (‚Ç¨)", "Calcul√©e sur 1 mois de loyer");
                    } else if (elId.includes('toggle-loan-rate')) {
                        toggleUI(e.target, formElements[type].loanRate, null, null);
                        document.getElementById(`${type}-loan-rate-status`).textContent = e.target.checked ? 'Manuel' : 'Auto';
                        if (!e.target.checked) fetchExcellentRate();
                    }
                    runSimulation();
                }
            });

            document.getElementById('form-container').addEventListener('click', async (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                if (button.classList.contains('btn-new')) {
                    formElements[currentInvestmentType].form.reset();
                    runSimulation();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else if (button.classList.contains('btn-save')) {
                    const originalText = button.textContent;
                    button.textContent = 'Sauvegarde...'; button.disabled = true;

                    const results = runSimulation();
                    if (!results) {
                        alert("Impossible de calculer les r√©sultats. V√©rifiez les param√®tres.");
                        button.textContent = originalText; button.disabled = false; return;
                    }
                    
 results.totalProfitPercentHorizon = results.totalAcquisitionCost > 0 ? 
        ((results.totalNetCashflowOverHorizon + results.finalNetGainAtHorizon) / results.totalAcquisitionCost) * 100 : 0;

                    const currentFormEls = formElements[currentInvestmentType];
                    const newSimData = {};
                    for (const key of Object.keys(currentFormEls)) {
                        if (key !== 'form') {
                           const element = currentFormEls[key];
                           newSimData[key] = element.type === 'checkbox' ? element.checked : element.value;
                        }
                    }

                    const cityName = currentFormEls.cityName.value || 'N/A';
                    let titleDetails = '';
                    if (currentInvestmentType === 'parking') titleDetails = `${currentFormEls.spacesCount.value} places`;
                    else if (currentInvestmentType === 'logement') titleDetails = `${currentFormEls.monthlyRentHc.value}‚Ç¨/mois`;
                    else if (currentInvestmentType === 'cave') titleDetails = `${currentFormEls.count.value} box`;
                    newSimData.title = `${cityName} - ${titleDetails}`;
                    
                    const success = await saveSimulationToFirestore({ type: currentInvestmentType, data: newSimData, results });

                    button.textContent = success ? 'Succ√®s !' : '√âchec';
                    setTimeout(() => { button.textContent = originalText; button.disabled = false; }, 2000);
                }
            });

            document.getElementById('print-btn').addEventListener('click', () => window.print());

            document.getElementById('saved-simulations-section').addEventListener('click', async (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const simId = button.dataset.id;
                
                if (button.classList.contains('load-sim-btn') && simId) {
                    const simToLoad = allUserSimulations.find(s => s.id === simId);
                    if (!simToLoad) return;
                    
                    showSimulator(simToLoad.type, false); // Affiche le simulateur SANS lancer de calcul
                    
                    const formToPopulate = formElements[simToLoad.type];
                    for (const key in simToLoad.data) {
                        if (formToPopulate.hasOwnProperty(key) && key !== 'form') {
                            const savedValue = simToLoad.data[key];
                            const element = formToPopulate[key];
                            if (element.type === 'checkbox') {
                                element.checked = savedValue;
                            } else {
                                element.value = savedValue || '';
                            }
                        }
                    }
                    
                    Object.values(formToPopulate).forEach(el => {
                        if(el && el.id && el.id.includes('toggle')) {
                            el.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    });
                    
                    runSimulation(); // Lance le calcul une seule fois APRES avoir tout rempli
                    window.scrollTo({ top: 0, behavior: 'smooth' });

                } else if (button.classList.contains('delete-sim-btn') && simId) {
                    if(confirm("√ätes-vous s√ªr de vouloir supprimer cette simulation ?")) {
                        await deleteSimulationFromFirestore(simId);
                    }
                } else if (button.classList.contains('sort-btn')) {
                     document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
                     button.classList.add('active');
                     const sortType = button.dataset.sort;
                     let sims = [...allUserSimulations].filter(s => s.results);
                     if (sortType === 'investment') sims.sort((a, b) => a.results.totalAcquisitionCost - b.results.totalAcquisitionCost);
                     else if (sortType === 'profit') sims.sort((a, b) => (b.results.totalProfitPercentHorizon || 0) - (a.results.totalProfitPercentHorizon || 0));
                     else if (sortType === 'name') sims.sort((a, b) => (a.data.title || '').localeCompare(b.data.title || ''));
                     renderSimulations(sims);
                }
            });
        });
    </script>
</body>
</html>